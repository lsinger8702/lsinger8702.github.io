<!DOCTYPE html>
<html lang="default">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css" integrity="sha256-2H3fkXt6FEmrReK448mDVGKb3WW2ZZw35gI7vqHOE4Y=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{&quot;hostname&quot;:&quot;yoursite.com&quot;,&quot;root&quot;:&quot;&#x2F;&quot;,&quot;images&quot;:&quot;&#x2F;images&quot;,&quot;scheme&quot;:&quot;Gemini&quot;,&quot;version&quot;:&quot;8.5.0&quot;,&quot;exturl&quot;:false,&quot;sidebar&quot;:{&quot;position&quot;:&quot;left&quot;,&quot;display&quot;:&quot;post&quot;,&quot;padding&quot;:18,&quot;offset&quot;:12},&quot;copycode&quot;:false,&quot;bookmark&quot;:{&quot;enable&quot;:false,&quot;color&quot;:&quot;#222&quot;,&quot;save&quot;:&quot;auto&quot;},&quot;fancybox&quot;:false,&quot;mediumzoom&quot;:false,&quot;lazyload&quot;:false,&quot;pangu&quot;:false,&quot;comments&quot;:{&quot;style&quot;:&quot;tabs&quot;,&quot;active&quot;:null,&quot;storage&quot;:true,&quot;lazyload&quot;:false,&quot;nav&quot;:null},&quot;motion&quot;:{&quot;enable&quot;:true,&quot;async&quot;:false,&quot;transition&quot;:{&quot;post_block&quot;:&quot;fadeIn&quot;,&quot;post_header&quot;:&quot;fadeInDown&quot;,&quot;post_body&quot;:&quot;fadeInDown&quot;,&quot;coll_header&quot;:&quot;fadeInLeft&quot;,&quot;sidebar&quot;:&quot;fadeInUp&quot;}},&quot;prism&quot;:false,&quot;i18n&quot;:{&quot;placeholder&quot;:&quot;Searching...&quot;,&quot;empty&quot;:&quot;We didn&#39;t find any results for the search: ${query}&quot;,&quot;hits_time&quot;:&quot;${hits} results found in ${time} ms&quot;,&quot;hits&quot;:&quot;${hits} results found&quot;}}</script><script src="/js/config.js"></script>
<meta name="description" content="基本理论ACID原子性（Atomicity） 事务最终的状态只有两种，全部执行成功和全部不执行，不会停留在中间某个环节  若处理事务的任何一项操作不成功，就会导致整个事务失败  一旦操作失败，所有操作都会被取消（即回滚），使得事务仿佛没有被执行过一样   一致性（Consistency） 是指事务操作前和操作后，数据满足完整性约束，数据库保持一致性状态  比如，用户 A 和用户 B 在银行分别有">
<meta property="og:type" content="article">
<meta property="og:title" content="分布式事务">
<meta property="og:url" content="http://yoursite.com/2021/06/06/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/index.html">
<meta property="og:site_name" content="Lsinger&#39; s blog">
<meta property="og:description" content="基本理论ACID原子性（Atomicity） 事务最终的状态只有两种，全部执行成功和全部不执行，不会停留在中间某个环节  若处理事务的任何一项操作不成功，就会导致整个事务失败  一旦操作失败，所有操作都会被取消（即回滚），使得事务仿佛没有被执行过一样   一致性（Consistency） 是指事务操作前和操作后，数据满足完整性约束，数据库保持一致性状态  比如，用户 A 和用户 B 在银行分别有">
<meta property="og:locale">
<meta property="article:published_time" content="2021-06-06T09:35:52.000Z">
<meta property="article:modified_time" content="2021-06-09T14:31:09.476Z">
<meta property="article:author" content="Lsinger">
<meta property="article:tag" content="Interview">
<meta property="article:tag" content="Distributed Transaction">
<meta property="article:tag" content="High Concurrency System">
<meta property="article:tag" content="Distributed Protocol">
<meta property="article:tag" content="Distributed System">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://yoursite.com/2021/06/06/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/">



<script class="next-config" data-name="page" type="application/json">{&quot;sidebar&quot;:&quot;&quot;,&quot;isHome&quot;:false,&quot;isPost&quot;:true,&quot;lang&quot;:&quot;default&quot;,&quot;comments&quot;:true,&quot;permalink&quot;:&quot;http:&#x2F;&#x2F;yoursite.com&#x2F;2021&#x2F;06&#x2F;06&#x2F;%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1&#x2F;&quot;,&quot;path&quot;:&quot;2021&#x2F;06&#x2F;06&#x2F;分布式事务&#x2F;&quot;,&quot;title&quot;:&quot;分布式事务&quot;}</script>

<script class="next-config" data-name="calendar" type="application/json">&quot;&quot;</script>
<title>分布式事务 | Lsinger' s blog</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Lsinger' s blog</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">Lsinger' s blog</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>







</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E7%90%86%E8%AE%BA"><span class="nav-number">1.</span> <span class="nav-text">基本理论</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ACID"><span class="nav-number">1.1.</span> <span class="nav-text">ACID</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8E%9F%E5%AD%90%E6%80%A7%EF%BC%88Atomicity%EF%BC%89"><span class="nav-number">1.1.1.</span> <span class="nav-text">原子性（Atomicity）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%80%E8%87%B4%E6%80%A7%EF%BC%88Consistency%EF%BC%89"><span class="nav-number">1.1.2.</span> <span class="nav-text">一致性（Consistency）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9A%94%E7%A6%BB%E6%80%A7%EF%BC%88Isolation%EF%BC%89"><span class="nav-number">1.1.3.</span> <span class="nav-text">隔离性（Isolation）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8C%81%E4%B9%85%E6%80%A7%EF%BC%88Durability%EF%BC%89"><span class="nav-number">1.1.4.</span> <span class="nav-text">持久性（Durability）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Base-%E7%90%86%E8%AE%BA"><span class="nav-number">1.2.</span> <span class="nav-text">Base 理论</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%83%8C%E6%99%AF"><span class="nav-number">1.2.1.</span> <span class="nav-text">背景</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E5%8F%AF%E7%94%A8"><span class="nav-number">1.2.2.</span> <span class="nav-text">基本可用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%94%E6%80%A7%E7%8A%B6%E6%80%81"><span class="nav-number">1.2.3.</span> <span class="nav-text">柔性状态</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%80%E7%BB%88%E4%B8%80%E8%87%B4%E6%80%A7"><span class="nav-number">1.2.4.</span> <span class="nav-text">最终一致性</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0"><span class="nav-number">1.2.4.1.</span> <span class="nav-text">实现</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="nav-number">2.</span> <span class="nav-text">解决方案</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%AC%E5%9C%B0%E6%B6%88%E6%81%AF%E8%A1%A8"><span class="nav-number">2.1.</span> <span class="nav-text">本地消息表</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%BA%E9%99%B7"><span class="nav-number">2.1.1.</span> <span class="nav-text">缺陷</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9D%9E%E4%BA%8B%E5%8A%A1%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="nav-number">2.1.2.</span> <span class="nav-text">非事务消息中间件</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%94%9F%E4%BA%A7%E7%AB%AF"><span class="nav-number">2.1.2.1.</span> <span class="nav-text">生产端</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B6%88%E8%B4%B9%E7%AB%AF"><span class="nav-number">2.1.2.2.</span> <span class="nav-text">消费端</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%94%AF%E6%8C%81%E4%BA%8B%E5%8A%A1%E7%9A%84%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="nav-number">2.1.3.</span> <span class="nav-text">支持事务的消息中间件</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A6%82%E5%BF%B5"><span class="nav-number">2.1.3.1.</span> <span class="nav-text">概念</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B5%81%E7%A8%8B"><span class="nav-number">2.1.3.2.</span> <span class="nav-text">流程</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%94%9F%E4%BA%A7%E8%80%85"><span class="nav-number">2.1.3.2.1.</span> <span class="nav-text">生产者</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%B6%88%E8%B4%B9%E8%80%85"><span class="nav-number">2.1.3.2.2.</span> <span class="nav-text">消费者</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SAGA"><span class="nav-number">2.2.</span> <span class="nav-text">SAGA</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%83%8C%E6%99%AF-1"><span class="nav-number">2.2.1.</span> <span class="nav-text">背景</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%82%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="nav-number">2.2.2.</span> <span class="nav-text">适用场景</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BC%98%E5%8A%BF"><span class="nav-number">2.2.3.</span> <span class="nav-text">优势</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%BA%E7%82%B9"><span class="nav-number">2.2.4.</span> <span class="nav-text">缺点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F"><span class="nav-number">2.2.5.</span> <span class="nav-text">实现方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%81%E7%A8%8B-1"><span class="nav-number">2.2.6.</span> <span class="nav-text">流程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AT"><span class="nav-number">2.3.</span> <span class="nav-text">AT</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%83%8C%E6%99%AF-2"><span class="nav-number">2.3.1.</span> <span class="nav-text">背景</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%97%A0%E4%BE%B5%E5%85%A5%E6%96%B9%E6%A1%88"><span class="nav-number">2.3.2.</span> <span class="nav-text">无侵入方案</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%80%E9%98%B6%E6%AE%B5"><span class="nav-number">2.3.2.1.</span> <span class="nav-text">一阶段</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BA%8C%E9%98%B6%E6%AE%B5"><span class="nav-number">2.3.2.2.</span> <span class="nav-text">二阶段</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%8F%90%E4%BA%A4"><span class="nav-number">2.3.2.2.1.</span> <span class="nav-text">提交</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%9B%9E%E6%BB%9A"><span class="nav-number">2.3.2.2.2.</span> <span class="nav-text">回滚</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%BA%E9%99%B7-1"><span class="nav-number">2.3.3.</span> <span class="nav-text">缺陷</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BC%98%E7%82%B9"><span class="nav-number">2.3.4.</span> <span class="nav-text">优点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%81%E7%A8%8B-2"><span class="nav-number">2.3.5.</span> <span class="nav-text">流程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3PC"><span class="nav-number">2.4.</span> <span class="nav-text">3PC</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%83%8C%E6%99%AF-3"><span class="nav-number">2.4.1.</span> <span class="nav-text">背景</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%81%E7%A8%8B-3"><span class="nav-number">2.4.2.</span> <span class="nav-text">流程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#CanCommit-%E9%98%B6%E6%AE%B5"><span class="nav-number">2.4.2.1.</span> <span class="nav-text">CanCommit 阶段</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#PreCommit-%E9%98%B6%E6%AE%B5"><span class="nav-number">2.4.2.2.</span> <span class="nav-text">PreCommit 阶段</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#DoCommit-%E9%98%B6%E6%AE%B5"><span class="nav-number">2.4.2.3.</span> <span class="nav-text">DoCommit 阶段</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#TCC"><span class="nav-number">2.5.</span> <span class="nav-text">TCC</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BC%98%E5%8A%BF-1"><span class="nav-number">2.5.1.</span> <span class="nav-text">优势</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%BA%E9%99%B7-2"><span class="nav-number">2.5.2.</span> <span class="nav-text">缺陷</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%82%E7%94%A8%E5%9C%BA%E6%99%AF-1"><span class="nav-number">2.5.3.</span> <span class="nav-text">适用场景</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%81%E7%A8%8B-4"><span class="nav-number">2.5.4.</span> <span class="nav-text">流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B9%82%E7%AD%89%E6%80%A7"><span class="nav-number">2.5.5.</span> <span class="nav-text">幂等性</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8E-XA-%E5%8D%8F%E8%AE%AE%E7%9A%84%E4%BA%8C%E9%98%B6%E6%AE%B5%E6%8F%90%E4%BA%A4%E6%96%B9%E6%B3%95-2PC"><span class="nav-number">2.6.</span> <span class="nav-text">基于 XA 协议的二阶段提交方法 2PC</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#XA-%E5%8D%8F%E8%AE%AE"><span class="nav-number">2.6.1.</span> <span class="nav-text">XA 协议</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A7%92%E8%89%B2"><span class="nav-number">2.6.1.1.</span> <span class="nav-text">角色</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%82%E7%94%A8%E5%9C%BA%E6%99%AF-2"><span class="nav-number">2.6.2.</span> <span class="nav-text">适用场景</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%81%E7%A8%8B-5"><span class="nav-number">2.6.3.</span> <span class="nav-text">流程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%87%86%E5%A4%87"><span class="nav-number">2.6.3.1.</span> <span class="nav-text">准备</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8F%90%E4%BA%A4-1"><span class="nav-number">2.6.3.2.</span> <span class="nav-text">提交</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%BA%E9%99%B7-3"><span class="nav-number">2.6.4.</span> <span class="nav-text">缺陷</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%90%8C%E6%AD%A5%E9%98%BB%E5%A1%9E"><span class="nav-number">2.6.4.1.</span> <span class="nav-text">同步阻塞</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8D%95%E7%82%B9%E6%95%85%E9%9A%9C"><span class="nav-number">2.6.4.2.</span> <span class="nav-text">单点故障</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E4%B8%8D%E4%B8%80%E8%87%B4"><span class="nav-number">2.6.4.3.</span> <span class="nav-text">数据不一致</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Percolator-%E6%A8%A1%E5%9E%8B"><span class="nav-number">2.7.</span> <span class="nav-text">Percolator 模型</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BC%98%E5%8A%BF-2"><span class="nav-number">2.7.1.</span> <span class="nav-text">优势</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E2%80%9C%E4%B8%80%E9%98%B6%E6%AE%B5%E6%8F%90%E4%BA%A4%E2%80%9C%E5%8D%8F%E8%AE%AE"><span class="nav-number">2.8.</span> <span class="nav-text">“一阶段提交“协议</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%92%E8%89%B2-1"><span class="nav-number">2.8.1.</span> <span class="nav-text">角色</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%81%E7%A8%8B-6"><span class="nav-number">2.8.2.</span> <span class="nav-text">流程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5"><span class="nav-number">2.8.2.1.</span> <span class="nav-text">第一阶段</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC%E4%BA%8C%E9%98%B6%E6%AE%B5"><span class="nav-number">2.8.2.2.</span> <span class="nav-text">第二阶段</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="nav-number">3.</span> <span class="nav-text">参考资料</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Lsinger</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">45</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">72</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="default">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/06/06/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Lsinger">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lsinger' s blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          分布式事务
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-06-06 17:35:52" itemprop="dateCreated datePublished" datetime="2021-06-06T17:35:52+08:00">2021-06-06</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2021-06-09 22:31:09" itemprop="dateModified" datetime="2021-06-09T22:31:09+08:00">2021-06-09</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Distributed-System/" itemprop="url" rel="index"><span itemprop="name">Distributed System</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="基本理论"><a href="#基本理论" class="headerlink" title="基本理论"></a>基本理论</h1><h2 id="ACID"><a href="#ACID" class="headerlink" title="ACID"></a>ACID</h2><h3 id="原子性（Atomicity）"><a href="#原子性（Atomicity）" class="headerlink" title="原子性（Atomicity）"></a>原子性（Atomicity）</h3><ul>
<li><p>事务最终的状态只有两种，全部执行成功和全部不执行，不会停留在中间某个环节</p>
</li>
<li><p>若处理事务的任何一项操作不成功，就会导致整个事务失败</p>
</li>
<li><p>一旦操作失败，所有操作都会被取消（即回滚），使得事务仿佛没有被执行过一样</p>
</li>
</ul>
<h3 id="一致性（Consistency）"><a href="#一致性（Consistency）" class="headerlink" title="一致性（Consistency）"></a>一致性（Consistency）</h3><ul>
<li><p>是指事务操作前和操作后，数据满足完整性约束，数据库保持一致性状态</p>
</li>
<li><p>比如，用户 A 和用户 B 在银行分别有 800 元和 600 元，总共 1400 元，用户 A 给用户 B 转账 200 元，分为两个步骤，从 A 的账户扣除 200 元和对 B 的账户增加 200 元。一致性就是要求上述步骤操作后，最后的结果是用户 A 还有 600 元，用户 B 有 800 元，总共 1400 元，而不会出现用户 A 扣除了 200 元，但用户 B 未增加的情况（该情况，用户 A 和 B 均为 600 元，总共 1200 元）。 </p>
</li>
</ul>
<span id="more"></span>

<h3 id="隔离性（Isolation）"><a href="#隔离性（Isolation）" class="headerlink" title="隔离性（Isolation）"></a>隔离性（Isolation）</h3><ul>
<li>指当系统内有多个事务并发执行时，多个事务同时使用相同的数据时，不会相互干扰，每个事务都有一个完整的数据空间，对其他并发事务是隔离的</li>
</ul>
<h3 id="持久性（Durability）"><a href="#持久性（Durability）" class="headerlink" title="持久性（Durability）"></a>持久性（Durability）</h3><ul>
<li><p>指一个事务被执行后，那么它对数据库所做的更新就永久地保存下来了</p>
</li>
<li><p>即使发生系统崩溃或宕机等故障，重新启动数据库系统后，只要数据库能够重新被访问，那么一定能够将其恢复到事务完成时的状态</p>
</li>
</ul>
<h2 id="Base-理论"><a href="#Base-理论" class="headerlink" title="Base 理论"></a>Base 理论</h2><h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><ul>
<li><p>BASE 理论是对 CAP 中一致性和可用性权衡的结果，它来源于对大规模互联网分布式系统实践的总结，是基于 CAP 定理逐步演化而来的</p>
</li>
<li><p>BASE 理论的核心思想是，如果不是必须的话，不推荐实现事务或强一致性，鼓励可用性和性能优先，根据业务的场景特点，来实现非常弹性的基本可用，以及实现数据的最终一致性</p>
</li>
<li><p>BASE 理论是 CAP 理论中的 AP 的延伸，是对互联网大规模分布式系统的实践总结，强调可用性</p>
</li>
<li><p>BASE 理论包括基本可用（Basically Available）、柔性状态（Soft State）和最终一致性（Eventual Consistency） </p>
</li>
</ul>
<h3 id="基本可用"><a href="#基本可用" class="headerlink" title="基本可用"></a>基本可用</h3><ul>
<li><p>当分布式系统在出现不可预知的故障时，允许损失部分功能的可用性，保障核心功能的可用</p>
</li>
<li><p>当系统节点出现大规模故障的时候，比如专线的光纤被挖断、突发流量导致系统过载（出现了突发事件，服务被大量访问），这个时候可以通过服务降级，牺牲部分功能的可用性，保障系统的核心功能可用</p>
</li>
<li><p>基本可用在本质上是一种妥协，也就是在出现节点故障或系统过载的时候，通过牺牲非核心功能的可用性，保障核心功能的稳定运行</p>
</li>
</ul>
<h3 id="柔性状态"><a href="#柔性状态" class="headerlink" title="柔性状态"></a>柔性状态</h3><ul>
<li><p>在柔性事务中，允许系统存在中间状态，且这个中间状态不会影响系统整体可用性</p>
</li>
<li><p>比如，数据库读写分离，写库同步到读库（主库同步到从库）会有一个延时，其实就是一种柔性状态</p>
</li>
</ul>
<h3 id="最终一致性"><a href="#最终一致性" class="headerlink" title="最终一致性"></a>最终一致性</h3><ul>
<li><p>最终一致性是说，系统中所有的数据副本在经过一段时间的同步后，最终能够达到一个一致的状态</p>
</li>
<li><p>几乎所有的互联网系统采用的都是最终一致性，只有在实在无法使用最终一致性，才使用强一致性或事务，比如，对于决定系统运行的敏感元数据，需要考虑采用强一致性，对于与钱有关的支付系统或金融系统的数据，需要考虑采用事务</p>
</li>
<li><p>如果业务的某功能无法容忍一致性的延迟（比如分布式锁对应的数据），需要实现的是强一致性</p>
</li>
<li><p>如果能容忍短暂的一致性的延迟（比如 QQ 状态数据），就可以考虑最终一致性</p>
</li>
</ul>
<h4 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h4><ul>
<li><p>首先要知道它以什么为准，因为这是实现最终一致性的关键</p>
<ul>
<li><p>以最新写入的数据为准，比如 AP 模型的 KV 存储采用的就是这种方式</p>
</li>
<li><p>以第一次写入的数据为准，如果你不希望存储的数据被更改，可以以它为准</p>
</li>
</ul>
</li>
<li><p>读时修复</p>
<ul>
<li><p>在读取数据时，检测数据的不一致，进行修复</p>
</li>
<li><p>比如 Cassandra 的 Read Repair 实现，具体来说，在向 Cassandra 系统查询数据的时候，如果检测到不同节点的副本数据不一致，系统就自动修复数据</p>
</li>
</ul>
</li>
<li><p>写时修复</p>
<ul>
<li><p>在写入数据，检测数据的不一致时，进行修复</p>
</li>
<li><p>比如 Cassandra 的 Hinted Handoff 实现。具体来说，Cassandra 集群的节点之间远程写数据的时候，如果写失败就将数据缓存下来，然后定时重传，修复数据的不一致性</p>
</li>
</ul>
</li>
<li><p>异步修复</p>
<ul>
<li><p>这个是最常用的方式</p>
</li>
<li><p>通过定时对账检测副本数据的一致性，并修复</p>
</li>
</ul>
</li>
<li><p>因为写时修复不需要做数据一致性对比，性能消耗比较低，对系统运行影响也不大，所以推荐在实现最终一致性时优先实现这种方式 </p>
</li>
</ul>
<h1 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h1><h2 id="本地消息表"><a href="#本地消息表" class="headerlink" title="本地消息表"></a>本地消息表</h2><ul>
<li><p>核心思想在于分布式系统在处理任务时通过消息日志的方式来异步执行</p>
</li>
<li><p>消息日志可以存储至本地文本、数据库或消息队列，然后再通过业务规则定时任务或人工自动重试</p>
</li>
<li><p>根据出错概率的大小来安排它们的操作顺序，最容易出错的最先进行</p>
</li>
</ul>
<h3 id="缺陷"><a href="#缺陷" class="headerlink" title="缺陷"></a>缺陷</h3><ul>
<li>可靠消息队列的整个实现过程完全没有任何隔离性可言，会导致超售等问题</li>
</ul>
<h3 id="非事务消息中间件"><a href="#非事务消息中间件" class="headerlink" title="非事务消息中间件"></a>非事务消息中间件</h3><h4 id="生产端"><a href="#生产端" class="headerlink" title="生产端"></a>生产端</h4><ul>
<li><p>操作数据库：Producer端准备1张消息表，把 update DB 和 insert message 这2个操作，放在一个DB事务里面 </p>
<ul>
<li>成功<ul>
<li>准备一个后台程序，源源不断的把消息表中的message传送给消息中间件 <ul>
<li>成功</li>
<li>正常情况</li>
<li>失败<ul>
<li>不断重试重传，允许消息重复，但消息不会丢，顺序也不会打乱</li>
<li>回滚数据库</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>失败</li>
<li>不投递消息</li>
</ul>
</li>
</ul>
<h4 id="消费端"><a href="#消费端" class="headerlink" title="消费端"></a>消费端</h4><ul>
<li><p>Consumer 端准备一个判重表</p>
<ul>
<li><p>取出消息，执行业务操作</p>
<ul>
<li><p>成功</p>
<ul>
<li>处理过的消息，记在判重表里面，实现业务的幂等 </li>
</ul>
</li>
<li><p>失败</p>
<ul>
<li>保证消息不能失效/丢失 </li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="支持事务的消息中间件"><a href="#支持事务的消息中间件" class="headerlink" title="支持事务的消息中间件"></a>支持事务的消息中间件</h3><ul>
<li><p>Apache 开源的 RocketMQ 中间件能够支持一种事务消息机制，确保本地操作和发送消息的异步处理达到本地事务的结果一致</p>
</li>
<li><p>RocketMQ 是通过<strong>半消息机制</strong>实现分布式事务</p>
</li>
</ul>
<h4 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h4><ul>
<li><p>事务消息</p>
<ul>
<li>MQ 提供类似 X/Open XA 的分布事务功能，通过 MQ 事务消息能达到分布式事务的最终一致</li>
</ul>
</li>
<li><p>半消息</p>
<ul>
<li>暂不能投递的消息，发送方已经将消息成功发送到了 MQ 服务端，但是服务端未收到生产者对该消息的二次确认，此时该消息被标记成“暂不能投递”状态，处于该种状态下的消息即半消息</li>
</ul>
</li>
<li><p>半消息回查</p>
<ul>
<li><p>由于网络闪断、生产者应用重启等原因，导致某条事务消息的二次确认丢失</p>
</li>
<li><p>MQ 服务端通过扫描发现某条消息长期处于“半消息”时，需要主动向消息生产者询问该消息的最终状态（Commit 或是 Rollback），该过程即消息回查 </p>
</li>
</ul>
</li>
</ul>
<h4 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h4><h5 id="生产者"><a href="#生产者" class="headerlink" title="生产者"></a>生产者</h5><ul>
<li><p>业务方保存本地事务记录，并初始化状态</p>
</li>
<li><p>业务方调用 sendMessageInTransaction 发送半消息到 MQ 的 RMQ_SYS_TRANS_HALF_TOPIC队列</p>
</li>
<li><p>MQ执行成功，回调业务方 executeLocalTransaction 方法，也就是业务方的业务逻辑</p>
</li>
<li><p>业务方返回事务状态给MQ</p>
<ul>
<li><p>commit</p>
<ul>
<li>塞一条消息进 REAL_TOPIC 真实队列，等待消费者消费</li>
</ul>
</li>
<li><p>rollback</p>
<ul>
<li>添加一条消息进RMQ_SYS_TRANS_OP_HALF_TOPIC队列，代表已处理消息</li>
</ul>
</li>
<li><p>unknow</p>
<ul>
<li><p>根据一定的频率回查业务方本地事务状态</p>
</li>
<li><p>MQ 内部有定时任务，轮询判定未处理（无结果）消息，并回查 checkLocalTransaction 接口获得业务方本地事务状态 </p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h5 id="消费者"><a href="#消费者" class="headerlink" title="消费者"></a>消费者</h5><ul>
<li><p>消费者会从 MQ 长轮询并发拉取消息，并根据初始化的 MessageLister 接口执行业务消费逻辑</p>
</li>
<li><p>MQ 根据返回的状态，如果是 RECONSUME_LATER 重试，就会入 SCHEDULE 延迟队列、RETRY重试队列、DLQ 死信队列</p>
</li>
<li><p>进入死信队列的消息，需要管理员手动排查问题</p>
</li>
</ul>
<h2 id="SAGA"><a href="#SAGA" class="headerlink" title="SAGA"></a>SAGA</h2><h3 id="背景-1"><a href="#背景-1" class="headerlink" title="背景"></a>背景</h3><ul>
<li><p>Saga 模式是一种长事务解决方案，保证事务最终一致性 </p>
</li>
<li><p>大致思路是把一个大事务分解为可以交错运行的一系列子事务的集合</p>
</li>
<li><p>原本提出 SAGA 的目的，是为了避免大事务长时间锁定数据库的资源，后来才逐渐发展成将一个分布式环境中的大事务，分解为一系列本地事务的设计模式</p>
</li>
<li><p>SAGA 系统本身也有可能会崩溃，所以它必须设计成与数据库类似的日志机制（被称为 SAGA Log），以保证系统恢复后可以追踪到子事务的执行情况，比如执行都到哪一步或者补偿到哪一步了</p>
</li>
<li><p>SAGA 事务通常也不会直接靠裸编码来实现，一般也是在事务中间件的基础上完成</p>
</li>
<li><p>Seata 支持 SAGA 事务模式</p>
</li>
</ul>
<h3 id="适用场景"><a href="#适用场景" class="headerlink" title="适用场景"></a>适用场景</h3><ul>
<li><p>业务流程长、业务流程多</p>
</li>
<li><p>参与者包含其他公司或遗留系统服务，无法提供 TCC 模式要求的三个接口</p>
</li>
<li><p>典型业务系统：如金融网络（与外部金融机构对接）、互联网微贷、渠道整合、分布式架构服务集成等业务系统</p>
</li>
<li><p>银行业金融机构使用广泛 </p>
</li>
</ul>
<h3 id="优势"><a href="#优势" class="headerlink" title="优势"></a>优势</h3><ul>
<li><p>一阶段提交本地事务，无锁，长流程情况下可以保证高性能</p>
</li>
<li><p>参与者可异步执行，高吞吐</p>
</li>
<li><p>补偿服务即正向服务的“反向”，易于理解，易于实现</p>
</li>
</ul>
<h3 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h3><ul>
<li><p>Saga 模式由于一阶段已经提交本地数据库事务，且没有进行“预留”动作，所以不能保证隔离性</p>
<ul>
<li><p>执行到后面失败，前面的步骤发生了脏写</p>
</li>
<li><p>通过正向补偿的方式完成事务</p>
</li>
</ul>
</li>
<li><p>悬挂</p>
<ul>
<li><p>补偿服务比原服务先执行</p>
</li>
<li><p>允许空补偿（原服务未执行，补偿服务执行了），并拒绝空补偿后的原服务执行</p>
</li>
</ul>
</li>
</ul>
<h3 id="实现方式"><a href="#实现方式" class="headerlink" title="实现方式"></a>实现方式</h3><ul>
<li><p>由事件驱动，各个参与者之间是异步执行的</p>
<ul>
<li><p>通过事件驱动的方法异步执行提高系统吞吐</p>
</li>
<li><p>可以实现服务编排需求，在 Saga 模式缺乏隔离性的情况下，可以多一种“向前重试”的事情恢复策略 </p>
</li>
<li><p>业务侵入性高</p>
</li>
<li><p>实现成本高</p>
</li>
</ul>
</li>
<li><p>基于注解加拦截器拦截业务的正向服务实现 </p>
<ul>
<li>开发简单、学习成本低 </li>
</ul>
</li>
</ul>
<h3 id="流程-1"><a href="#流程-1" class="headerlink" title="流程"></a>流程</h3><ul>
<li><p>把大事务拆分成若干个小事务，将整个分布式事务 T 分解为 n 个子事务，我们命名为 T1，T2，…，Ti，…，Tn</p>
<ul>
<li><p>每个子事务都应该、或者能被看作是原子行为</p>
</li>
<li><p>如果分布式事务 T 能够正常提交，那么它对数据的影响（最终一致性）就应该与连续按顺序成功提交子事务 Ti 等价</p>
</li>
</ul>
</li>
<li><p>另一部分是为每一个子事务设计对应的补偿动作，我们命名为 C1，C2，…，Ci，…，Cn</p>
<ul>
<li><p>Ti 与 Ci 都具备幂等性</p>
</li>
<li><p>Ti 与 Ci 满足交换律（Commutative），即不管是先执行 Ti 还是先执行 Ci，效果都是一样的</p>
</li>
<li><p>Ci 必须能成功提交，即不考虑 Ci 本身提交失败被回滚的情况</p>
</li>
<li><p>如果出现就必须持续重试直至成功，或者要人工介入</p>
</li>
</ul>
</li>
<li><p>如果 T1 到 Tn 均成功提交，那么事务就可以顺利完成</p>
</li>
<li><p>否则，我们就要采取以下两种恢复策略之一</p>
<ul>
<li><p>正向恢复（Forward Recovery）</p>
<ul>
<li><p>如果 Ti 事务提交失败，则一直对 Ti 进行重试，直至成功为止（最大努力交付）</p>
</li>
<li><p>这种恢复方式不需要补偿，适用于事务最终都要成功的场景，比如在别人的银行账号中扣了款，就一定要给别人发货</p>
</li>
</ul>
</li>
<li><p>反向恢复（Backward Recovery）</p>
<ul>
<li><p>如果 Ti 事务提交失败，么分布式事务会去退回去执行前面各参与者的逆向回滚操作（C1…Ci-1），回滚已提交的参与者，使分布式事务回到初始状态</p>
</li>
<li><p>这里要求逆向回滚操作必须（在持续重试后）执行成功 </p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="AT"><a href="#AT" class="headerlink" title="AT"></a>AT</h2><h3 id="背景-2"><a href="#背景-2" class="headerlink" title="背景"></a>背景</h3><ul>
<li><p>AT 模式是一种无侵入的分布式事务解决方案</p>
</li>
<li><p>AT 事务是参照了 XA 两段提交协议来实现的</p>
</li>
<li><p>针对 XA 2PC 的缺陷，即在准备阶段，必须等待所有数据源都返回成功后，协调者才能统一发出 Commit 命令而导致的木桶效应（所有涉及到的锁和资源，都需要等到最慢的事务完成后才能统一释放），AT 事务设计了针对性的解决方案</p>
</li>
<li><p>在 AT 模式下，用户只需关注自己的“业务 SQL”，用户的 “业务 SQL” 作为一阶段，Seata 框架会自动生成事务的二阶段提交和回滚操作</p>
</li>
</ul>
<h3 id="无侵入方案"><a href="#无侵入方案" class="headerlink" title="无侵入方案"></a>无侵入方案</h3><h4 id="一阶段"><a href="#一阶段" class="headerlink" title="一阶段"></a>一阶段</h4><ul>
<li><p>Seata 会拦截“业务 SQL”，首先解析 SQL 语义，找到“业务 SQL”要更新的业务数据，在业务数据被更新前，将其保存成“before image”</p>
</li>
<li><p>然后执行“业务 SQL”更新业务数据</p>
</li>
<li><p>在业务数据更新之后，再将其保存成“after image”</p>
</li>
<li><p>最后生成行锁，提交业务SQL</p>
</li>
<li><p>以上操作全部在一个数据库事务内完成，这样保证了一阶段操作的原子性</p>
</li>
</ul>
<h4 id="二阶段"><a href="#二阶段" class="headerlink" title="二阶段"></a>二阶段</h4><h5 id="提交"><a href="#提交" class="headerlink" title="提交"></a>提交</h5><ul>
<li>因为“业务 SQL”在一阶段已经提交至数据库， 所以 Seata 框架只需将一阶段保存的快照数据和行锁删掉，完成数据清理即可</li>
</ul>
<h5 id="回滚"><a href="#回滚" class="headerlink" title="回滚"></a>回滚</h5><ul>
<li><p>Seata 就需要回滚一阶段已经执行的“业务 SQL”，还原业务数据</p>
</li>
<li><p>首先要校验脏写，对比“数据库当前业务数据”和 “after image”</p>
<ul>
<li><p>如果两份数据完全一致就说明没有脏写</p>
<ul>
<li>用“before image”还原业务数据</li>
</ul>
</li>
<li><p>如果不一致就说明有脏写</p>
<ul>
<li>需要转人工处理</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="缺陷-1"><a href="#缺陷-1" class="headerlink" title="缺陷"></a>缺陷</h3><ul>
<li><p>而使用的代价就是大幅度地牺牲了隔离性，甚至直接影响到了原子性</p>
</li>
<li><p>因为在缺乏隔离性的前提下，以补偿代替回滚不一定总能成功</p>
<ul>
<li><p>当在本地事务提交之后、分布式事务完成之前，该数据被补偿之前又被其他操作修改过，即出现了脏写（Dirty Wirte），而这个时候一旦出现分布式事务需要回滚，就不可能再通过自动的逆向 SQL 来实现补偿，只能由人工介入处理了</p>
</li>
<li><p>GTS 增加了一个“全局锁”（Global Lock）的机制来实现写隔离，要求本地事务提交之前，一定要先拿到针对修改记录的全局锁后才允许提交，而在没有获得全局锁之前就必须一直等待</p>
</li>
<li><p>在读隔离方面，AT 事务默认的隔离级别是读未提交（Read Uncommitted），这意味着可能会产生脏读（Dirty Read）</p>
</li>
<li><p>读隔离也可以采用全局锁的方案来解决，但直接阻塞读取的话，我们要付出的代价就非常大了，一般并不会这样做</p>
</li>
</ul>
</li>
</ul>
<h3 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h3><ul>
<li><p>AT 事务这种异步提交的模式，相比 2PC 极大地提升了系统的吞吐量水平</p>
</li>
<li><p>不侵入业务</p>
</li>
</ul>
<h3 id="流程-2"><a href="#流程-2" class="headerlink" title="流程"></a>流程</h3><ul>
<li><p>在业务数据提交时，自动拦截所有 SQL，分别保存 SQL 对数据修改前后结果的快照，生成行锁，通过本地事务一起提交到操作的数据源中，这就相当于自动记录了重做和回滚日志</p>
</li>
<li><p>如果分布式事务成功提交了，那么我们后续只需清理每个数据源中对应的日志数据即可</p>
</li>
<li><p>如果分布式事务需要回滚，就要根据日志数据自动产生用于补偿的“逆向 SQL”</p>
</li>
<li><p>基于这种补偿方式，分布式事务中所涉及的每一个数据源都可以单独提交，然后立刻释放锁和资源</p>
</li>
</ul>
<h2 id="3PC"><a href="#3PC" class="headerlink" title="3PC"></a>3PC</h2><h3 id="背景-3"><a href="#背景-3" class="headerlink" title="背景"></a>背景</h3><ul>
<li>对二阶段提交（2PC）的改进，为了更好地处理两阶段提交的同步阻塞和数据不一致问题，三阶段提交引入了超时机制和准备阶段</li>
</ul>
<h3 id="流程-3"><a href="#流程-3" class="headerlink" title="流程"></a>流程</h3><h4 id="CanCommit-阶段"><a href="#CanCommit-阶段" class="headerlink" title="CanCommit 阶段"></a>CanCommit 阶段</h4><ul>
<li><p>协调者向参与者发送请求操作（CanCommit 请求），询问参与者是否可以执行事务提交操作，然后等待参与者的响应</p>
</li>
<li><p>参与者收到 CanCommit 请求之后，回复 Yes，表示可以顺利执行事务；否则回复 No。</p>
</li>
<li><p>3PC 的 CanCommit 阶段与 2PC 的 Voting 阶段相比，不同之处在于</p>
<ul>
<li><p>在 2PC 中，在投票阶段，若参与者可以执行事务，会将操作信息记录到事务日志中但不提交，并返回结果给协调者</p>
</li>
<li><p>但在 3PC 中，在 CanCommit 阶段，参与者仅会判断是否可以顺利执行事务，并返回结果</p>
</li>
<li><p>而操作信息记录到事务日志但不提交的操作由第二阶段预提交阶段执行</p>
</li>
</ul>
</li>
</ul>
<h4 id="PreCommit-阶段"><a href="#PreCommit-阶段" class="headerlink" title="PreCommit 阶段"></a>PreCommit 阶段</h4><ul>
<li><p>协调者根据参与者的回复情况，来决定是否可以进行 PreCommit 操作（预提交阶段）</p>
</li>
<li><p>如果所有参与者回复的都是“Yes”，那么协调者就会执行事务的预执行</p>
<ul>
<li>协调者向参与者发送 PreCommit 请求，进入预提交阶段</li>
<li>参与者接收到 PreCommit 请求后执行事务操作，并将 Undo 和 Redo 信息记录到事务日志中</li>
<li>如果参与者成功执行了事务操作，则返回 ACK 响应，同时开始等待最终指令</li>
</ul>
</li>
<li><p>假如任何一个参与者向协调者发送了“No”消息，或者等待超时之后，协调者都没有收到参与者的响应，就执行中断事务的操作</p>
<ul>
<li>协调者向所有参与者发送“Abort”消息</li>
<li>参与者收到“Abort”消息之后，或超时后仍未收到协调者的消息，执行事务的中断操作</li>
</ul>
</li>
</ul>
<h4 id="DoCommit-阶段"><a href="#DoCommit-阶段" class="headerlink" title="DoCommit 阶段"></a>DoCommit 阶段</h4><ul>
<li><p>DoCmmit 阶段进行真正的事务提交，根据 PreCommit 阶段协调者发送的消息，进入执行提交阶段或事务中断阶段</p>
</li>
<li><p>执行提交阶段</p>
<ul>
<li><p>若协调者接收到所有参与者发送的 Ack 响应，则向所有参与者发送 DoCommit 消息，开始执行阶段</p>
</li>
<li><p>参与者接收到 DoCommit 消息之后，正式提交事务</p>
</li>
<li><p>完成事务提交之后，释放所有锁住的资源，并向协调者发送 Ack 响应</p>
</li>
<li><p>协调者接收到所有参与者的 Ack 响应之后，完成事务</p>
</li>
</ul>
</li>
<li><p>事务中断阶段</p>
<ul>
<li><p>协调者向所有参与者发送 Abort 请求</p>
</li>
<li><p>参与者接收到 Abort 消息之后，利用其在 PreCommit 阶段记录的 Undo 信息执行事务的回滚操作，释放所有锁住的资源，并向协调者发送 Ack 消息</p>
</li>
<li><p>协调者接收到参与者反馈的 Ack 消息之后，执行事务的中断，并结束事务</p>
</li>
</ul>
</li>
</ul>
<h2 id="TCC"><a href="#TCC" class="headerlink" title="TCC"></a>TCC</h2><ul>
<li><p>使用 TCC 协议时，由应用系统负责协议的实现，数据库没有额外工作</p>
</li>
<li><p>TCC 是位于用户代码层面，而不是在基础设施层面，这就为它的实现带来了较高的灵活性，我们可以根据需要设计资源锁定的粒度 </p>
</li>
<li><p>用户接入 TCC 模式，最重要的事情就是考虑如何将业务模型拆成 2 阶段，实现成 TCC 的 3 个方法，并且保证 Try 成功 Confirm 一定能成功</p>
</li>
<li><p>可以基于某些分布式事务中间件（如阿里开源的Seata）来完成，以尽量减轻一些编码工作量 </p>
</li>
</ul>
<h3 id="优势-1"><a href="#优势-1" class="headerlink" title="优势"></a>优势</h3><ul>
<li><p>TCC 在业务执行的时候，只操作预留资源，几乎不会涉及到锁和资源的争用，所以它具有很高的性能潜力 </p>
</li>
<li><p>具有较强的隔离性</p>
</li>
</ul>
<h3 id="缺陷-2"><a href="#缺陷-2" class="headerlink" title="缺陷"></a>缺陷</h3><ul>
<li><p>TCC 最主要的限制是它的业务侵入性很强，但并不是指由此给开发编码带来的工作量，而是指它所要求的技术可控性上的约束</p>
</li>
<li><p>参与者包含其他公司或遗留系统服务，无法提供 TCC 模式要求的三个接口</p>
</li>
<li><p>悬挂</p>
<ul>
<li><p>Cancel 比 Try 接口先执行，Try 由于网络拥堵而超时，事务管理器生成回滚，触发 Cancel 接口，而最终又收到了 Try 接口调用，但是 Cancel 比 Try 先到</p>
</li>
<li><p>按照前面允许空回滚的逻辑，回滚会返回成功，事务管理器认为事务已回滚成功</p>
</li>
<li><p>此时的 Try 接口不应该执行，否则会产生数据不一致</p>
</li>
<li><p>在 Cancel 空回滚返回成功之前先记录该条事务 xid 或业务主键，标识这条记录已经回滚过，Try 接口先检查这条事务xid或业务主键如果已经标记为回滚成功过，则不执行 Try 的业务操作</p>
</li>
</ul>
</li>
</ul>
<h3 id="适用场景-1"><a href="#适用场景-1" class="headerlink" title="适用场景"></a>适用场景</h3><ul>
<li><p>具有较强的隔离性，能够有效避免“超售”的问题</p>
</li>
<li><p>性能可以说是包括可靠消息队列在内的几种柔性事务模式中最高的 </p>
</li>
<li><p>单元化架构+单体数据库</p>
<ul>
<li><p>单元化架构是对业务应用系统的彻底重构</p>
</li>
<li><p>应用系统被拆分成若干实例，配置独立的单体数据库，让每个实例管理一定范围的数据</p>
</li>
<li><p>例如对于银行贷款系统，可以为每个支行搭建独立的应用实例，管理支行各自的用户，当出现跨支行业务时，由应用层代码通过分布式事务组件保证事务的 ACID 特性</p>
</li>
</ul>
</li>
</ul>
<h3 id="流程-4"><a href="#流程-4" class="headerlink" title="流程"></a>流程</h3><ul>
<li><p>Try</p>
<ul>
<li>尝试执行阶段，完成所有业务可执行性的检查（保障一致性），并且预留好事务需要用到的所有业务资源（保障隔离性）</li>
</ul>
</li>
<li><p>Confirm</p>
<ul>
<li>确认执行阶段，不进行任何业务检查，直接使用 Try 阶段准备的资源来完成业务处理</li>
</ul>
</li>
<li><p>Cancel</p>
<ul>
<li>取消执行阶段，释放 Try 阶段预留的业务资源</li>
</ul>
</li>
</ul>
<h3 id="幂等性"><a href="#幂等性" class="headerlink" title="幂等性"></a>幂等性</h3><ul>
<li>考虑到网络的不可靠，操作指令必须能够被重复执行，这就要求 Try、Confirm、Cancel 必须是幂等性操作，也就是说，要确保执行多次与执行一次得到相同的结果</li>
</ul>
<h2 id="基于-XA-协议的二阶段提交方法-2PC"><a href="#基于-XA-协议的二阶段提交方法-2PC" class="headerlink" title="基于 XA 协议的二阶段提交方法 2PC"></a>基于 XA 协议的二阶段提交方法 2PC</h2><h3 id="XA-协议"><a href="#XA-协议" class="headerlink" title="XA 协议"></a>XA 协议</h3><ul>
<li><p>XA 是一个分布式事务协议，规定了事务管理器和资源管理器接口</p>
</li>
<li><p>尽量保证了数据的强一致性，而且实现成本低 </p>
</li>
</ul>
<h4 id="角色"><a href="#角色" class="headerlink" title="角色"></a>角色</h4><ul>
<li><p>事务管理器</p>
<ul>
<li><p>相当于协调者，负责各个本地资源的提交和回滚</p>
</li>
<li><p>作为事务的协调者只有一个</p>
</li>
</ul>
</li>
<li><p>资源管理器</p>
<ul>
<li><p>资源管理器就是分布式事务的参与者，通常由数据库实现，比如 Oracle、DB2 等商业数据库都实现了 XA 接口</p>
</li>
<li><p>作为参与者执行具体操作允许有多个 </p>
</li>
</ul>
</li>
</ul>
<h3 id="适用场景-2"><a href="#适用场景-2" class="headerlink" title="适用场景"></a>适用场景</h3><ul>
<li><p>分库分表</p>
</li>
<li><p>所有客户的数据被分散存储在多个数据库实例中，这些数据库实例具有完全相同的表结构</p>
<ul>
<li>业务逻辑部署在应用服务器上，通过数据库中间件访问底层的数据库实例</li>
<li>数据库中间件作为事务管理器，资源管理器就是指底层的数据库实例</li>
</ul>
</li>
</ul>
<h3 id="流程-5"><a href="#流程-5" class="headerlink" title="流程"></a>流程</h3><h4 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h4><ul>
<li><p>协调者（Coordinator，即事务管理器）会向事务的参与者（Cohort，即本地资源管理器）发起执行操作的 CanCommit 请求，并等待参与者的响应</p>
</li>
<li><p>参与者接收到请求后，会执行请求中的事务操作，将操作信息记录到事务日志中但不提交（即不会修改数据库中的数据）</p>
<ul>
<li><p>待参与者执行成功，则向协调者发送“Yes”消息，表示同意操作</p>
</li>
<li><p>若不成功，则发送“No”消息，表示终止操作</p>
</li>
</ul>
</li>
<li><p>当所有的参与者都返回了操作结果（Yes 或 No 消息）后，系统进入了第二阶段提交阶段</p>
</li>
</ul>
<h4 id="提交-1"><a href="#提交-1" class="headerlink" title="提交"></a>提交</h4><ul>
<li><p>协调者会根据所有参与者返回的信息向参与者发送 DoCommit（提交）或 DoAbort（取消）指令</p>
<ul>
<li><p>若协调者从参与者那里收到的都是“Yes”消息</p>
<ul>
<li><p>则向参与者发送“DoCommit”消息</p>
</li>
<li><p>参与者收到“DoCommit”消息后，完成剩余的操作（比如修改数据库中的数据）并释放资源（整个事务过程中占用的资源）</p>
</li>
<li><p>然后向协调者返回“HaveCommitted”消息</p>
</li>
</ul>
</li>
<li><p>若协调者从参与者收到的消息中包含“No”消息</p>
<ul>
<li><p>则向所有参与者发送“DoAbort”消息</p>
</li>
<li><p>此时投票阶段发送“Yes”消息的参与者，则会根据之前执行操作时的事务日志对操作进行回滚，就好像没有执行过请求操作一样，然后所有参与者会向协调者发送“HaveCommitted”消息</p>
</li>
<li><p>协调者接收到来自所有参与者的“HaveCommitted”消息后，就意味着整个事务结束了</p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="缺陷-3"><a href="#缺陷-3" class="headerlink" title="缺陷"></a>缺陷</h3><h4 id="同步阻塞"><a href="#同步阻塞" class="headerlink" title="同步阻塞"></a>同步阻塞</h4><ul>
<li>执行过程中，数据库要锁定对应的数据行</li>
<li>如果其他事务刚好也要操作这些数据行，那它们就只能等待</li>
<li>因此基于 XA 的二阶段提交协议不支持高并发场景</li>
</ul>
<h4 id="单点故障"><a href="#单点故障" class="headerlink" title="单点故障"></a>单点故障</h4><ul>
<li>事务管理器非常重要，一旦发生故障，数据库会一直阻塞下去</li>
</ul>
<h4 id="数据不一致"><a href="#数据不一致" class="headerlink" title="数据不一致"></a>数据不一致</h4><ul>
<li>当事务管理器向参与者发送 Commit 请求之后，发生了局部网络异常，导致只有部分数据库接收到请求，但是其他数据库未接到请求所以无法提交事务</li>
</ul>
<h2 id="Percolator-模型"><a href="#Percolator-模型" class="headerlink" title="Percolator 模型"></a>Percolator 模型</h2><ul>
<li><p>在 TiDB 和 CockroachDB 中有具体落地</p>
</li>
<li><p>使用 Percolator 模型的前提是事务的参与者，即数据库，要支持多版本并发控制（MVCC）</p>
</li>
</ul>
<h3 id="优势-2"><a href="#优势-2" class="headerlink" title="优势"></a>优势</h3><ul>
<li><p>通过将Commit操作变成原子操作来解决数据不一致的问题</p>
</li>
<li><p>Percolator 引入的异步线程可以在事务管理器宕机后，回滚各个分片上的事务，提供了善后手段，不会让分片上被占用的资源无法释放</p>
</li>
<li><p>事务管理器可以用记录日志的方式使自身无状态化，日志通过共识算法同时保存在系统的多个节点上。这样，事务管理器宕机后，可以在其他节点启动新的事务管理器，基于日志恢复事务操作</p>
</li>
</ul>
<h2 id="“一阶段提交“协议"><a href="#“一阶段提交“协议" class="headerlink" title="“一阶段提交“协议"></a>“一阶段提交“协议</h2><ul>
<li><p>GoldenDB 中实现的“一阶段提交”协议</p>
</li>
<li><p>本质上是改变了资源的申请方式，更准确的说法是，并发控制手段从锁调度变为时间戳排序（Timestamp Ordering） </p>
</li>
</ul>
<h3 id="角色-1"><a href="#角色-1" class="headerlink" title="角色"></a>角色</h3><ul>
<li><p>协调节点</p>
</li>
<li><p>数据节点</p>
</li>
<li><p>全局事务器</p>
</li>
<li><p>管理节点</p>
</li>
<li><p>协调节点和数据节点均有多个</p>
</li>
</ul>
<h3 id="流程-6"><a href="#流程-6" class="headerlink" title="流程"></a>流程</h3><h4 id="第一阶段"><a href="#第一阶段" class="headerlink" title="第一阶段"></a>第一阶段</h4><ul>
<li><p>GoldenDB 的协调节点接到事务后，在全局事务管理器（GTM）的全局事务列表中将事务标记成活跃的状态</p>
</li>
<li><p>这个标记过程是 GoldenDB 的主要改进点，实质是通过全局事务列表来申请资源，规避可能存在的事务竞争</p>
</li>
<li><p>这样的好处是避免了与所有参与者的通讯，也减少了很多无效的资源锁定动作</p>
</li>
</ul>
<h4 id="第二阶段"><a href="#第二阶段" class="headerlink" title="第二阶段"></a>第二阶段</h4><ul>
<li><p>协调节点把一个全局事务分拆成若干子事务，分配给对应的 MySQL 去执行</p>
</li>
<li><p>如果所有操作成功，协调者节点会将全局事务列表中的事务标记为结束，整个事务处理完成</p>
</li>
<li><p>如果失败，子事务在单机上自动回滚，而后反馈给协调者节点，后者向所有数据节点下发回滚指令</p>
</li>
</ul>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a target="_blank" rel="noopener" href="https://www.sofastack.tech/blog/sofa-meetup-3-seata-retrospect/">https://www.sofastack.tech/blog/sofa-meetup-3-seata-retrospect/</a></li>
<li>聂鹏程 《分布式技术原理与算法解析》</li>
<li>李玥 《消息队列高手课》</li>
<li>周志明 《周志明的软件架构课》</li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Interview/" rel="tag"># Interview</a>
              <a href="/tags/Distributed-Transaction/" rel="tag"># Distributed Transaction</a>
              <a href="/tags/High-Concurrency-System/" rel="tag"># High Concurrency System</a>
              <a href="/tags/Distributed-Protocol/" rel="tag"># Distributed Protocol</a>
              <a href="/tags/Distributed-System/" rel="tag"># Distributed System</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2021/06/05/JVM-%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/" rel="prev" title="JVM 垃圾回收">
                  <i class="fa fa-chevron-left"></i> JVM 垃圾回收
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2021/06/06/%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6/" rel="next" title="虚拟机类加载机制">
                  虚拟机类加载机制 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Lsinger</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
